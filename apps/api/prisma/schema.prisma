generator client {
  provider   = "prisma-client-js"
  output     = "./generated/prisma"
  engineType = "client" // enable Prisma ORM without Rust
}

datasource db {
  provider = "postgresql"
}
enum UserRole {
  ADMIN
  MANAGER
  TECHNICIAN
}

enum FactoryStatus {
  ACTIVE
  INACTIVE
}
enum EquipmentStatus {
  ACTIVE
  MAINTENANCE
  INACTIVE
}

enum EquipmentPriority {
  HIGH
  MEDIUM
  LOW
}

enum ChecklistCycle {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  SEMI_ANNUALLY
  YEARLY
}

enum ChecklistStatus {
  DRAFT
  ACTIVE
  INACTIVE
}

enum ChecklistExecutionStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  SKIPPED
  FAILED
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  fullName  String
  role      UserRole @default(TECHNICIAN)
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  assignedChecklists ChecklistTemplate[]

  @@map("users")
}

model Factory {
  id        String        @id @default(uuid())
  code      String        @unique
  name      String
  location  String?
  status    FactoryStatus @default(ACTIVE)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Relationships
  equipments Equipment[]

  @@index([status])
  @@index([code])
  @@map("factories")
}

 model Equipment {
  id           String            @id @default(uuid())
  code         String            @unique
  name         String // Name/List of machine
  category     String // Chủng loại máy (Type of machine)
  origin       String? // Xuất xứ (Original)
  brand        String? // Thương hiệu (Trademark)
  modelYear    Int? // Năm sản xuất (Model year)
  image        String? // Hình ảnh (Picture)
  qrCode       String? // Mã QR (QR Code)
  dimension    String? // Kích thước (Dimension)
  quantity     Int     @default(1) // Số lượng (Quantity)
  factoryId    String?
  
  status       EquipmentStatus   @default(ACTIVE)
  notes        String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  // Relationships
  factory      Factory?          @relation(fields: [factoryId], references: [id], onDelete: SetNull)
  documents    EquipmentDocument[]
  
  // Checklist relationships
  checklistTemplates   ChecklistTemplate[]
  checklistAssignments EquipmentChecklistAssignment[]
  checklistExecutions  ChecklistExecution[]

  // Indexes for high performance querying
  @@index([category])
  @@index([status])
  @@index([code])
  @@index([name])
  @@map("equipments")
}

model EquipmentDocument {
  id          String   @id @default(uuid())
  name        String   // Original file name
  path        String   // File path (relative)
  type        String?  // MIME type
  size        Int?     // Size in bytes
  equipmentId String
  createdAt   DateTime @default(now())

  equipment   Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@index([equipmentId])
  @@map("equipment_documents")
}

enum ImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model ImportHistory {
  id               String       @id @default(uuid())
  fileName         String
  fileSize         Int?         // File size in bytes
  totalRecords     Int          @default(0)
  processedRecords Int          @default(0)
  successCount     Int          @default(0)
  failedCount      Int          @default(0)
  status           ImportStatus @default(PENDING)
  errorFileUrl     String?
  importType       String       @default("EQUIPMENT") // Use string for flexibility or enum if strict
  
  startedAt        DateTime?
  finishedAt       DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@map("import_histories")
}

// ==========================================
// CHECKLIST LIBRARY MODELS
// ==========================================

model ChecklistTemplate {
  id                String          @id @default(uuid())
  code              String          @unique
  name              String
  description       String?
  
  // Equipment relationship (REQUIRED)
  equipmentId       String
  equipment         Equipment       @relation(fields: [equipmentId], references: [id])
  
  // Assigned User (OPTIONAL)
  assignedUserId    String?
  assignedUser      User?           @relation(fields: [assignedUserId], references: [id])
  
  // Department (OPTIONAL)
  department        String?
  
  // Maintenance Start Date (OPTIONAL)
  maintenanceStartDate DateTime?
  
  // Scheduling
  cycle             ChecklistCycle @default(MONTHLY)
  
  // Versioning
  version           Int            @default(1)
  status            ChecklistStatus @default(DRAFT)
  
  // Metadata
  notes             String?
  createdBy         String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  // Relationships
  items                ChecklistTemplateItem[]
  equipmentAssignments EquipmentChecklistAssignment[]
  executions           ChecklistExecution[]
  
  @@index([equipmentId])
  @@index([assignedUserId])
  @@index([status])
  @@index([cycle])
  @@map("checklist_templates")
}

model ChecklistTemplateItem {
  id                   String              @id @default(uuid())
  templateId           String
  order                Int
  
  // Item content (from Excel)
  maintenanceTask      String
  judgmentStandard     String?
  inspectionMethod     String?
  maintenanceContent   String?
  expectedResult       String?
  
  // Constraints
  isRequired           Boolean @default(false)
  requiresImage        Boolean @default(false)
  requiresNote         Boolean @default(false)
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  // Relationships
  template             ChecklistTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  @@index([templateId])
  @@map("checklist_template_items")
}

model EquipmentChecklistAssignment {
  id                String              @id @default(uuid())
  equipmentId       String
  templateId        String
  
  // Scheduling
  isActive          Boolean @default(true)
  startDate         DateTime?
  endDate           DateTime?
  
  // Assignment metadata
  assignedBy        String?
  assignedAt        DateTime @default(now())
  notes             String?
  
  // Relationships
  equipment         Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  template          ChecklistTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  @@unique([equipmentId, templateId])
  @@index([equipmentId])
  @@index([templateId])
  @@map("equipment_checklist_assignments")
}

model ChecklistExecution {
  id                String                    @id @default(uuid())
  templateId        String
  equipmentId       String
  workOrderId       String?
  
  // Execution info
  scheduledDate     DateTime
  actualStartDate   DateTime?
  actualEndDate     DateTime?
  status            ChecklistExecutionStatus @default(NOT_STARTED)
  
  // Personnel
  assignedTo        String?
  completedBy       String?
  approvedBy        String?
  approvedAt        DateTime?
  
  // Results
  overallResult     String?
  notes             String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relationships
  template          ChecklistTemplate @relation(fields: [templateId], references: [id])
  equipment         Equipment @relation(fields: [equipmentId], references: [id])
  items             ChecklistExecutionItem[]
  attachments       ChecklistExecutionAttachment[]
  
  @@index([equipmentId])
  @@index([templateId])
  @@index([status])
  @@index([scheduledDate])
  @@map("checklist_executions")
}

model ChecklistExecutionItem {
  id                String                @id @default(uuid())
  executionId       String
  templateItemId    String?
  order             Int
  
  // Content (copied from template)
  maintenanceTask   String
  judgmentStandard  String?
  inspectionMethod  String?
  maintenanceContent String?
  expectedResult    String?
  
  // Execution results
  actualResult      String?
  equipmentStatus   String?
  isPassed          Boolean?
  notes             String?
  
  // Completion info
  isCompleted       Boolean @default(false)
  completedAt       DateTime?
  completedBy       String?
  
  // Constraints
  isRequired        Boolean @default(false)
  requiresImage     Boolean @default(false)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relationships
  execution         ChecklistExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  images            ChecklistExecutionItemImage[]
  
  @@index([executionId])
  @@map("checklist_execution_items")
}

model ChecklistExecutionItemImage {
  id            String                  @id @default(uuid())
  itemId        String
  path          String
  description   String?
  uploadedAt    DateTime @default(now())
  uploadedBy    String?
  
  item          ChecklistExecutionItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  @@index([itemId])
  @@map("checklist_execution_item_images")
}

model ChecklistExecutionAttachment {
  id            String              @id @default(uuid())
  executionId   String
  name          String
  path          String
  type          String?
  size          Int?
  uploadedAt    DateTime @default(now())
  uploadedBy    String?
  
  execution     ChecklistExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  
  @@index([executionId])
  @@map("checklist_execution_attachments")
}
